---
- name: Deploy VMs from Ubuntu template using data from CSV
  hosts: localhost
  gather_facts: no
  vars_prompt:
        - name: "vcenter_hostname"
          prompt: "Enter vCenter hostname"
        - name: "vcenter_username"
          prompt: "Enter vCenter username"
        - name: "vcenter_password"
          prompt: "Enter vCenter password"
        - name: "datacenter"
          prompt: "Enter datacenter name"
        - name: "cluster_name"
          prompt: "Enter cluster name"
        - name: "folder_name"
          prompt: "Enter VM folder name"
        - name: "dataStoreName"
          prompt: "Enter datastore name"
        - name: "PortGroupName"
          prompt: "Enter PortGroupName"
  tasks:
    - name: Read VM data from CSV
      read_csv:
        path: ./vms.csv
        fieldnames:
          - Vmname
          - cpuCount
          - MemorySize
          - diskSize
          - dataStoreName
          - PortGroupName
          - ip
          - subnet_mask
          - default_gateway
      register: csv_data

    - name: Deploy VMs from Ubuntu template
      vmware_guest:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: no
        datacenter: "{{ datacenter }}"
        cluster: "{{ cluster_name }}"
        folder: "/{{ datacenter }}/{{ folder_name }}"
        name: "{{ item.Vmname }}"
        state: present
        template: "Ubuntu-2204-Template-100-Thin" # Name of your Ubuntu template VM
        disk:
          - size_gb: "{{ (item.diskSize|int / 1024)|int }}"
            type: thin
            datastore: "{{ datastore }}"
        hardware:
            memory_mb: "{{ item.MemorySize }}"
            num_cpus: "{{ item.cpuCount }}"
        networks:
          - name: "{{ item.PortGroupName }}"
            ip: "{{ item.ip }}"
            netmask: "{{ item.subnet_mask }}"
            gateway: "{{ item.default_gateway }}"
            type: "static"
        customization:
          hostname: "{{ item.Vmname }}"
      loop: "{{ csv_data.list }}"
      delegate_to: localhost
